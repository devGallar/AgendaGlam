App.Pages.Booking=function(){let e=$("#select-date"),t=$("#select-service"),a=$("#select-provider"),i=$("#select-timezone"),l=$("#first-name"),n=$("#last-name"),s=$("#email"),r=$("#phone-number"),o=$("#address"),d=$("#city"),c=$("#zip-code"),m=$("#notes"),v=$(".captcha-title"),p=$("#available-hours"),f=$("#book-appointment-submit"),u=$("#delete-personal-information"),g=$("#custom-field-1"),h=$("#custom-field-2"),b=$("#custom-field-3"),k=$("#custom-field-4"),y=$("#custom-field-5"),D=window.tippy,Y=window.moment,U=vars("manage_mode")||!1;function C(e,t){return e.isAfter(t)?-1:1}function x(e,t){let a=$(e);a.length&&a.val(App.Utils.Url.queryParam(t))}return document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("select-category"),t=document.getElementById("select-service");e.addEventListener("change",function(){let e=this.value;Array.from(t.options).forEach(e=>{e.style.display="none"}),Array.from(t.options).forEach(t=>{(t.getAttribute("data-category")===e||""===e)&&(t.style.display="block")}),t.value=""})}),document.addEventListener("DOMContentLoaded",function _(){if(Boolean(Number(vars("display_cookie_notice")))&&window?.cookieconsent){cookieconsent.initialise({palette:{popup:{background:"#ffffffbd",text:"#666666"},button:{background:"#429a82",text:"#ffffff"}},content:{message:lang("website_using_cookies_to_ensure_best_experience"),dismiss:"OK"}});let w=$(".cc-link");w.replaceWith($("<a/>",{"data-bs-toggle":"modal","data-bs-target":"#cookie-notice-modal",href:"#",class:"cc-link",text:w.text()}))}U=vars("manage_mode"),D("[data-tippy-content]");let H;App.Utils.UI.initializeDatePicker(e,{inline:!0,minDate:Y().subtract(1,"day").set({hours:23,minutes:59,seconds:59}).toDate(),maxDate:Y().add(vars("future_booking_limit"),"days").toDate(),onChange(e){App.Http.Booking.getAvailableHours(Y(e[0]).format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame()},onMonthChange(i,l,n){e.parent().fadeTo(400,.3),H&&clearTimeout(H),H=setTimeout(()=>{let e=Y(n.selectedDates[0]),i=Y(n.currentYearElement.value+"-"+String(Number(n.monthsDropdownContainer.value)+1).padStart(2,"0")+"-01"),l=C(e,i);App.Http.Booking.getUnavailableDates(a.val(),t.val(),i.format("YYYY-MM-DD"),l)},500)},onYearChange(e,i,l){setTimeout(()=>{let e=Y(l.selectedDates[0]),i=Y(l.currentYearElement.value+"-"+(Number(l.monthsDropdownContainer.value)+1)+"-01"),n=C(e,i);App.Http.Booking.getUnavailableDates(a.val(),t.val(),i.format("YYYY-MM-DD"),n)},500)}}),App.Utils.UI.setDateTimePickerValue(e,new Date);let M=Intl.DateTimeFormat().resolvedOptions().timeZone,B=i.find(`option[value="${M}"]`).length>0;if(i.val(B?M:"UTC"),i.on("change",()=>{let t=App.Utils.UI.getDateTimePickerValue(e);t&&(App.Http.Booking.getAvailableHours(Y(t).format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame())}),a.on("change",a=>{let i=$(a.target),l=new Date,n=Y(l);App.Utils.UI.setDateTimePickerValue(e,l),App.Http.Booking.getUnavailableDates(i.val(),t.val(),n.format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame()}),t.on("change",i=>{let l=$(i.target),n=t.val();a.empty(),a.append(new Option(lang("Selecciona uno"),"")),vars("available_providers").forEach(e=>{let t=e.services.filter(e=>Number(e)===Number(n)).length>0;t&&a.append(new Option(e.first_name+" "+e.last_name,e.id))}),a.find("option").length>1&&"1"===vars("display_any_provider")&&$(new Option(lang("any_provider"),"any-provider")).insertAfter(a.find("option:first")),App.Http.Booking.getUnavailableDates(a.val(),l.val(),Y(App.Utils.UI.getDateTimePickerValue(e)).format("YYYY-MM-DD")),App.Pages.Booking.updateConfirmFrame(),App.Pages.Booking.updateServiceDescription(n)}),$(".button-next").on("click",e=>{let t=$(e.currentTarget);if("1"===t.attr("data-step_index")&&!a.val())return;if("2"===t.attr("data-step_index")&&!$(".selected-hour").length){$("#select-hour-prompt").length||$("<div/>",{id:"select-hour-prompt",class:"text-danger mb-4",text:lang("appointment_hour_missing")}).prependTo("#available-hours");return}if("3"===t.attr("data-step_index")){if(!App.Pages.Booking.validateCustomerForm())return;App.Pages.Booking.updateConfirmFrame()}let i=parseInt(t.attr("data-step_index"))+1;t.parents().eq(1).fadeOut(()=>{$(".active-step").removeClass("active-step"),$("#step-"+i).addClass("active-step"),$("#wizard-frame-"+i).fadeIn()});let l=document.scrollingElement||document.body;window.innerHeight<l.scrollHeight&&(l.scrollTop=0)}),$(".button-back").on("click",e=>{let t=parseInt($(e.currentTarget).attr("data-step_index"))-1;$(e.currentTarget).parents().eq(1).fadeOut(()=>{$(".active-step").removeClass("active-step"),$("#step-"+t).addClass("active-step"),$("#wizard-frame-"+t).fadeIn()})}),p.on("click",".available-hour",e=>{p.find(".selected-hour").removeClass("selected-hour"),$(e.target).addClass("selected-hour"),App.Pages.Booking.updateConfirmFrame()}),U&&($("#cancel-appointment").on("click",()=>{let e=$("#cancel-appointment-form"),t,a=[{text:lang("close"),click(e,t){t.hide()}},{text:lang("confirm"),click(){if(""===t.val()){t.css("border","2px solid #DC3545");return}e.find("#hidden-cancellation-reason").val(t.val()),e.submit()}},];return App.Utils.Message.show(lang("cancel_appointment_title"),lang("write_appointment_removal_reason"),a),t=$("<textarea/>",{class:"form-control",id:"cancellation-reason",rows:"3",css:{width:"100%"}}).appendTo("#message-modal .modal-body"),!1}),u.on("click",()=>{let e=[{text:lang("cancel"),click(e,t){t.hide()}},{text:lang("delete"),click(){App.Http.Booking.deletePersonalInformation(vars("customer_token"))}},];App.Utils.Message.show(lang("delete_personal_information"),lang("delete_personal_information_prompt"),e)})),f.on("click",()=>{let e=$("#accept-to-terms-and-conditions");if(e.removeClass("is-invalid"),e.length&&!e.prop("checked")){e.addClass("is-invalid");return}let t=$("#accept-to-privacy-policy");if(t.removeClass("is-invalid"),t.length&&!t.prop("checked")){t.addClass("is-invalid");return}App.Http.Booking.registerAppointment()}),v.on("click","button",()=>{$(".captcha-image").attr("src",App.Utils.Url.siteUrl("captcha?"+Date.now()))}),e.on("mousedown",".ui-datepicker-calendar td",()=>{setTimeout(()=>{App.Http.Booking.applyPreviousUnavailableDates()},300)}),function e(){let t=$("#wizard-frame-3 .field-col:first"),a=t.find(".form-control"),i=$("#wizard-frame-3 .field-col:last"),l=i.find(".form-control");1===a.length&&l.length>1&&a.each((e,t)=>{$(t).parent().insertBefore(l.first().parent())}),1===l.length&&a.length>1&&l.each((e,t)=>{$(t).parent().insertAfter(a.last().parent())});let n=$(document).find("#wizard-frame-3 .field-col");n.each((e,t)=>{let a=$(t);a.find(".form-control").length||a.hide()})}(),U)(function v(p,f,u){try{t.val(p.id_services).trigger("change"),a.val(p.id_users_provider);let D=Y(p.start_datetime);App.Utils.UI.setDateTimePickerValue(e,D.toDate()),App.Http.Booking.getAvailableHours(D.format("YYYY-MM-DD")),n.val(u.last_name),l.val(u.first_name),s.val(u.email),r.val(u.phone_number),o.val(u.address),d.val(u.city),c.val(u.zip_code),u.timezone&&i.val(u.timezone);let U=null!==p.notes?p.notes:"";return m.val(U),g.val(u.custom_field_1),h.val(u.custom_field_2),b.val(u.custom_field_3),k.val(u.custom_field_4),y.val(u.custom_field_5),App.Pages.Booking.updateConfirmFrame(),!0}catch(C){return!1}})(vars("appointment_data"),vars("provider_data"),vars("customer_data")),$("#wizard-frame-1").css({visibility:"visible",display:"none"}).fadeIn();else{let P=App.Utils.Url.queryParam("service");P&&t.find('option[value="'+P+'"]').length>0&&t.val(P),t.trigger("change");let z=App.Utils.Url.queryParam("provider");if(z&&0===a.find('option[value="'+z+'"]').length)for(let E in vars("available_providers")){let I=vars("available_providers")[E];I.id===z&&I.services.length>0&&t.val(I.services[0]).trigger("change")}z&&a.find('option[value="'+z+'"]').length>0&&a.val(z).trigger("change"),P&&z||1===vars("available_services").length&&1===vars("available_providers").length?(P||t.val(vars("available_services")[0].id).trigger("change"),z||a.val(vars("available_providers")[0].id).trigger("change"),$(".active-step").removeClass("active-step"),$("#step-2").addClass("active-step"),$("#wizard-frame-1").hide(),$("#wizard-frame-2").fadeIn(),t.closest(".wizard-frame").find(".button-next").trigger("click"),$(document).find(".book-step:first").hide(),$(document).find(".button-back:first").css("visibility","hidden"),$(document).find(".book-step:not(:first)").each((e,t)=>$(t).find("strong").text(e+1))):$("#wizard-frame-1").css({visibility:"visible",display:"none"}).fadeIn(),x("#first-name","first_name"),x("#last-name","last_name"),x("#email","email"),x("#phone-number","phone"),x("#address","address"),x("#city","city"),x("#zip-code","zip")}}),document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("select-category"),t=document.getElementById("select-service");e.addEventListener("change",function(){let e=this.value;Array.from(t.options).forEach(e=>{e.style.display="none"}),Array.from(t.options).forEach(t=>{(t.getAttribute("data-category")===e||""===e)&&(t.style.display="block")}),t.value=""})}),document.getElementById("phone-number").addEventListener("input",function(e){this.value=this.value.replace(/\D/g,"")}),{manageMode:U,updateConfirmFrame:function v(){let f=t.find("option:selected").text();$(".display-selected-service").text(f).removeClass("invisible");let u=a.find("option:selected").text();if($(".display-selected-provider").text(u).removeClass("invisible"),!p.find(".selected-hour").text())return;let D=t.val(),C=vars("available_services").find(e=>Number(e.id)===Number(D));if(!C)return;let x=App.Utils.UI.getDateTimePickerValue(e),_=Y(x),w=_.format("YYYY-MM-DD"),H=p.find(".selected-hour").text(),M=`${w} ${H}`,B;x&&(B=App.Utils.Date.format(M,vars("date_format"),vars("time_format"),!0)),i.find("option:selected").text(),$("#appointment-details").html(`
            <div class="card" width: 24rem;>
                <div class="card-body">
                    <h2 class="card-titulo">Cita</h2>
                    <div class="mb-2 fw-bold fs-3">
                        <span>Servicio: </span>${f}
                    </div>
                    <div class="mb-2 fw-bold text-muted">
                        <span>Estilista: </span>${u}
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-calendar-day me-2"></i>
                        <span>Fecha: </span>${B}
                    </div>
                    <div class="mb-2 ${Number(C.price)?"":"d-none"}">
                        <i class="fas fa-cash-register me-2"></i>
                        <span>Precio: </span>${Number(C.price).toLocaleString("es-ES",{minimumFractionDigits:0,maximumFractionDigits:2}).replace(",",".")} ${C.currency}
                    </div>
                </div>
            </div>
        `);let P=App.Utils.String.escapeHtml(l.val()),z=App.Utils.String.escapeHtml(n.val()),E=`${P} ${z}`.trim(),I=App.Utils.String.escapeHtml(s.val()),T=App.Utils.String.escapeHtml(r.val()),F=App.Utils.String.escapeHtml(o.val()),S=App.Utils.String.escapeHtml(d.val()),A=App.Utils.String.escapeHtml(c.val()),L=[];S&&L.push(S),A&&L.push(A),$("#customer-details").html(`
            <div class="card" width: 24rem;>
                <div class="card-body">
                    <h2 class="card-titulo">informaci\xf3n de contacto</h2>
                        <div class="mb-2 fw-bold text-muted" ${E?"":"hidden"}>
                           <span>Nombre: </span> ${E}
                        </div>
                        <div class="mb-2" ${I?"":"hidden"}>
                           <span>Correo: </span>  ${I}
                        </div>
                        <div class="mb-2" ${T?"":"hidden"}>
                           <span>Numero: </span>  ${T}
                        </div>
                        <div class="mb-2" ${F?"":"hidden"}>
                            ${F}
                        </div>
                        <div class="mb-2" ${L.length?"":"hidden"}>
                            ${L.join(", ")}
                        </div>
                </div>
            </div>
        `);let V={};V.customer={last_name:n.val(),first_name:l.val(),email:s.val(),phone_number:r.val(),address:o.val(),city:d.val(),zip_code:c.val(),timezone:i.val(),custom_field_1:g.val(),custom_field_2:h.val(),custom_field_3:b.val(),custom_field_4:k.val(),custom_field_5:y.val()},V.appointment={start_datetime:Y(App.Utils.UI.getDateTimePickerValue(e)).format("YYYY-MM-DD")+" "+Y($(".selected-hour").data("value"),"HH:mm").format("HH:mm")+":00",end_datetime:function a(){let i=t.val(),l=vars("available_services").find(e=>Number(e.id)===Number(i)),n=Y(App.Utils.UI.getDateTimePickerValue(e)).format("YYYY-MM-DD"),s=$(".selected-hour").data("value"),r=Y(n+" "+s),o;return(o=l.duration&&r?r.clone().add({minutes:parseInt(l.duration)}):Y()).format("YYYY-MM-DD HH:mm:ss")}(),notes:m.val(),is_unavailability:!1,id_users_provider:a.val(),id_services:t.val()},V.manage_mode=Number(U),U&&(V.appointment.id=vars("appointment_data").id,V.customer.id=vars("customer_data").id),$('input[name="post_data"]').val(JSON.stringify(V))},updateServiceDescription:function e(t){let a=$("#service-description");a.empty();let i=vars("available_services").find(e=>Number(e.id)===Number(t));if(!i)return;let l=[];if(i.duration&&l.push(`${lang("duration")}: ${i.duration} ${lang("minutes")}`),Number(i.price)>0&&l.push(`${lang("price")}: ${Number(i.price).toFixed(2)} ${i.currency}`),i.location&&l.push(`${lang("location")}: ${i.location}`),l.length&&$(`
                <div class="mb-2 fst-italic">
                    ${l.join(", ")}
                </div>
            `).appendTo(a),i.description?.length){let n=App.Utils.String.escapeHtml(i.description),s=n.replaceAll("\n","<br/>");$(`
                <div class="text-muted">
                    ${s}
                </div>
            `).appendTo(a)}},validateCustomerForm:function e(){$("#wizard-frame-3 .is-invalid").removeClass("is-invalid"),$("#wizard-frame-3 label.text-danger").removeClass("text-danger");let t=!1;if($(".required").each((e,a)=>{$(a).val()||($(a).addClass("is-invalid"),t=!0)}),t)return $("#form-message").text(lang("fields_are_required")),!1;if(s.val()&&!App.Utils.Validation.email(s.val()))return s.addClass("is-invalid"),$("#form-message").text(lang("invalid_email")),!1;let a=r.val();return!a||!!App.Utils.Validation.phone(a)||(r.addClass("is-invalid"),$("#form-message").text(lang("invalid_phone")),!1)}}}();